#!/bin/bash -e

# Execute the default S2I script
/usr/libexec/s2i/assemble

# Set the version in an environment variable for the frontend to pickup
VITE_VERSION=$(poetry version | cut -d' ' -f2)
if [ -n "${OPENSHIFT_BUILD_COMMIT}" -a -n "${OPENSHIFT_BUILD_REFERENCE}" ]; then
    VITE_VERSION="${VITE_VERSION} (${OPENSHIFT_BUILD_REFERENCE}:${OPENSHIFT_BUILD_COMMIT:0:7})"
fi
export VITE_VERSION

# Build the frontend
cd frontend
npm install

if [ "$FEDORA_ENV" == "staging" ]; then
    NPM_EXTRA_ARGS="-- --mode staging"
fi
npm run build ${NPM_EXTRA_ARGS}
